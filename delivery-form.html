<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // API URL
        const API_URL = 'https://ph-mp-api.vercel.app';

        // –ü–æ–ª—É—á–∞–µ–º orderId –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');

        if (!orderId) {
            document.getElementById('root').innerHTML = `
                <div style="${styles.container}">
                    <div style="${styles.errorBox}">
                        <h2>‚ùå –ü–æ–º–∏–ª–∫–∞</h2>
                        <p>ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                    </div>
                </div>
            `;
        } else {
            renderForm();
        }

        function renderForm() {
            const root = document.getElementById('root');
            
            root.innerHTML = `
                <div style="${styles.container}">
                    <div style="${styles.header}">
                        <h1 style="${styles.title}">üì¶ –î–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</h1>
                        <p style="${styles.subtitle}">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ù–æ–≤–æ—é –ü–æ—à—Ç–æ—é</p>
                    </div>

                    <form id="deliveryForm" style="${styles.form}">
                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                            <input 
                                type="tel" 
                                name="phone" 
                                placeholder="+380 XX XXX XX XX"
                                required
                                style="${styles.input}"
                            />
                        </div>

                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–ü—Ä—ñ–∑–≤–∏—â–µ *</label>
                            <input 
                                type="text" 
                                name="lastName" 
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ"
                                required
                                style="${styles.input}"
                            />
                        </div>

                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–Ü–º'—è *</label>
                            <input 
                                type="text" 
                                name="firstName" 
                                placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è"
                                required
                                style="${styles.input}"
                            />
                        </div>

                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–ú—ñ—Å—Ç–æ *</label>
                            <input 
                                type="text" 
                                name="city" 
                                placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤"
                                required
                                style="${styles.input}"
                            />
                        </div>

                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–û–±–ª–∞—Å—Ç—å *</label>
                            <input 
                                type="text" 
                                name="region" 
                                placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤—Å—å–∫–∞"
                                required
                                style="${styles.input}"
                            />
                        </div>

                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–†–∞–π–æ–Ω</label>
                            <input 
                                type="text" 
                                name="district" 
                                placeholder="–í–≤–µ–¥—ñ—Ç—å —Ä–∞–π–æ–Ω (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"
                                style="${styles.input}"
                            />
                        </div>

                        <div style="${styles.formGroup}">
                            <label style="${styles.label}">–°–∫–ª–∞–¥ –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏ ‚Ññ *</label>
                            <input 
                                type="text" 
                                name="warehouse" 
                                placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 5"
                                required
                                style="${styles.input}"
                            />
                        </div>

                        <div id="errorMessage" style="${styles.errorMessage}"></div>

                        <button 
                            type="submit" 
                            id="submitBtn"
                            style="${styles.submitBtn}"
                        >
                            –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ
                        </button>
                    </form>
                </div>
            `;

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            document.getElementById('deliveryForm').addEventListener('submit', handleSubmit);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            const formData = new FormData(e.target);
            const data = {
                orderId: orderId,
                phone: formData.get('phone'),
                lastName: formData.get('lastName'),
                firstName: formData.get('firstName'),
                city: formData.get('city'),
                region: formData.get('region'),
                district: formData.get('district'),
                warehouse: formData.get('warehouse')
            };

            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = true;
            submitBtn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...';
            submitBtn.style.opacity = '0.6';
            errorMessage.textContent = '';

            try {
                const response = await fetch(\`\${API_URL}/api/delivery-data\`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // –£—Å–ø–µ—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    document.getElementById('root').innerHTML = \`
                        <div style="\${styles.container}">
                            <div style="\${styles.successBox}">
                                <div style="\${styles.successIcon}">‚úÖ</div>
                                <h2 style="\${styles.successTitle}">–î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!</h2>
                                <p style="\${styles.successText}">
                                    –¢–µ–ø–µ—Ä –æ–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏ –≤ —á–∞—Ç—ñ –∑ –±–æ—Ç–æ–º
                                </p>
                                <button 
                                    style="\${styles.closeBtn}"
                                    onclick="window.Telegram.WebApp.close()"
                                >
                                    –ó–∞–∫—Ä–∏—Ç–∏
                                </button>
                            </div>
                        </div>
                    \`;
                } else {
                    throw new Error(result.error || '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏');
                }

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                errorMessage.textContent = error.message || '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
                errorMessage.style.display = 'block';
                
                submitBtn.disabled = false;
                submitBtn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ';
                submitBtn.style.opacity = '1';
            }
        }

        // –°—Ç–∏–ª–∏
        const styles = {
            container: `
                font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
                background-color: #17212b;
                color: #ffffff;
                min-height: 100vh;
                padding: 20px;
            `,
            header: `
                text-align: center;
                margin-bottom: 30px;
            `,
            title: `
                font-size: 24px;
                font-weight: 800;
                margin: 0 0 8px 0;
                color: #ffffff;
            `,
            subtitle: `
                font-size: 14px;
                color: #a0aec0;
                margin: 0;
            `,
            form: `
                max-width: 500px;
                margin: 0 auto;
            `,
            formGroup: `
                margin-bottom: 20px;
            `,
            label: `
                display: block;
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #ffffff;
            `,
            input: `
                width: 100%;
                padding: 14px 16px;
                font-size: 16px;
                border: 2px solid #2d3748;
                border-radius: 12px;
                background-color: #1a252f;
                color: #ffffff;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                font-family: 'Manrope', sans-serif;
            `,
            submitBtn: `
                width: 100%;
                padding: 16px;
                font-size: 16px;
                font-weight: 700;
                color: white;
                background-color: #667eea;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                margin-top: 10px;
            `,
            errorMessage: `
                display: none;
                padding: 12px 16px;
                background-color: #fee2e2;
                color: #991b1b;
                border-radius: 10px;
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 20px;
                text-align: center;
            `,
            errorBox: `
                text-align: center;
                padding: 60px 20px;
                max-width: 400px;
                margin: 0 auto;
            `,
            successBox: `
                text-align: center;
                padding: 60px 20px;
                max-width: 400px;
                margin: 0 auto;
            `,
            successIcon: `
                font-size: 64px;
                margin-bottom: 20px;
            `,
            successTitle: `
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 12px;
                color: #ffffff;
            `,
            successText: `
                font-size: 16px;
                color: #a0aec0;
                margin-bottom: 24px;
                line-height: 1.5;
            `,
            closeBtn: `
                padding: 14px 32px;
                background-color: #667eea;
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
            `
        };

        // CSS –¥–ª—è focus —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
            input:focus {
                border-color: #667eea !important;
            }
            
            button:hover:not(:disabled) {
                background-color: #5568d3 !important;
                transform: translateY(-1px);
            }
            
            button:disabled {
                cursor: not-allowed !important;
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
